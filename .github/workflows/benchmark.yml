# Dogfooding: git-bench benchmarks itself
# This workflow tests git-bench by running it on its own codebase.
# For external projects, see .github/workflows/benchmark-example.yml
name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Use nightly for libtest benchmarks (#![feature(test)])
      # Criterion benchmarks also work on nightly
      - uses: dtolnay/rust-toolchain@nightly

      - name: Install git-bench (from local source for dogfooding)
        run: |
          # For dogfooding: install from local source to test current changes
          # External projects should use: cargo install --git https://github.com/fedemagnani/git-bench git-bench
          cargo install --path crates/cli

      - name: Build dashboard (from local source for dogfooding)
        run: |
          # For dogfooding: build dashboard from local source
          # External projects should use: cargo install --git https://github.com/fedemagnani/git-bench git-bench-dashboard
          rustup target add wasm32-unknown-unknown
          cargo install dioxus-cli
          cd crates/dashboard && dx build --release
          cp -r target/dx/git-bench-dashboard/release/web/public ../../dist
          # Fix absolute paths for GitHub Pages subdirectory deployment
          find ../../dist -type f \( -name "*.html" -o -name "*.js" \) -exec sed -i 's|"/\./|"./|g' {} \;
          # Add base tag to prevent URL manipulation
          sed -i 's|<head>|<head><base href="./">|' ../../dist/index.html

      - name: Run benchmarks
        run: cargo bench 2>&1 | tee benchmark-output.txt

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy results
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git-bench run \
            --output-file benchmark-output.txt \
            --name "git-bench" \
            --github-token "$GITHUB_TOKEN" \
            --auto-push \
            --gh-pages-branch gh-pages \
            --benchmark-data-dir-path dev/bench \
            --dashboard-dir dist \
            --alert-threshold "150%"

      - name: Upload benchmark output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-output
          path: benchmark-output.txt
          if-no-files-found: ignore
