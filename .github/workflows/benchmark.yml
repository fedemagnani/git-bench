# Dogfooding: git-bench benchmarks itself
name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@stable

      - name: Setup
        run: |
          rustup target add wasm32-unknown-unknown
          cargo install dioxus-cli wasm-bindgen-cli
          # Install git-bench from this repo
          cargo install --path crates/cli

      - name: Build dashboard
        run: |
          cd crates/dashboard && dx build --release
          cp -r target/dx/git-bench-dashboard/release/web/public ../../dist
          # Fix absolute paths for GitHub Pages subdirectory deployment
          find ../../dist -type f \( -name "*.html" -o -name "*.js" \) -exec sed -i 's|"/\./|"./|g' {} \;

      - name: Run benchmarks
        run: cargo bench 2>&1 | tee benchmark-output.txt

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy results
        if: github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git-bench run \
            --output-file benchmark-output.txt \
            --name "git-bench" \
            --github-token "$GITHUB_TOKEN" \
            --auto-push \
            --gh-pages-branch gh-pages \
            --benchmark-data-dir-path dev/bench \
            --dashboard-dir dist \
            --alert-threshold "150%"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-data
          path: benchmark-data.json
          if-no-files-found: ignore
