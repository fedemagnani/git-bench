#!/bin/bash
# Build script for git-bench-dashboard
#
# 100% Rust build process - all HTML/CSS is generated from Rust code.
#
# Prerequisites:
#   - rustup target add wasm32-unknown-unknown
#   - cargo install wasm-bindgen-cli

set -e

echo "ğŸ¦€ Building git-bench-dashboard (100% Rust)"
echo ""

# Step 1: Generate index.html from Rust
echo "ğŸ“„ Generating index.html from Rust..."
cargo run --bin generate_html --release

# Step 2: Build the WASM binary
echo ""
echo "ğŸ”¨ Building WASM binary..."
cargo build --release --target wasm32-unknown-unknown

# Step 3: Run wasm-bindgen to generate JS bindings (auto-generated, not hand-written)
echo ""
echo "ğŸ”— Generating WASM bindings..."
wasm-bindgen \
    --target web \
    --out-dir dist \
    --out-name git_bench_dashboard \
    target/wasm32-unknown-unknown/release/git-bench-dashboard.wasm

# Step 4: Optional - Optimize WASM size
if command -v wasm-opt &> /dev/null; then
    echo ""
    echo "ğŸ“¦ Optimizing WASM with wasm-opt..."
    wasm-opt -Oz -o dist/git_bench_dashboard_bg.wasm dist/git_bench_dashboard_bg.wasm
fi

echo ""
echo "âœ… Build complete!"
echo ""
echo "ğŸ“ Output in ./dist/:"
ls -la dist/
echo ""
echo "All files are either:"
echo "  - Compiled from Rust (*.wasm)"
echo "  - Auto-generated bindings (*.js, *.d.ts)"
echo "  - Generated by Rust code (index.html)"
echo ""
echo "ğŸš€ To test: cd dist && python3 -m http.server 8081"
echo "   Then copy your benchmark-data.json to dist/data.json"
